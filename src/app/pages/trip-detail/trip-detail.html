<div class="loading-screen" *ngIf="loading"><div class="spinner"></div></div>

<div class="detail-container" *ngIf="trip">
  
  <div class="hero" [style.backgroundImage]="'url(' + (trip.imageUrl || 'https://via.placeholder.com/1200x400') + ')'">
    <div class="hero-overlay">
      <button class="btn-back" routerLink="/trips">â† Volver</button>
      <h1>{{ trip.destination }}</h1>
      <p>{{ trip.startDate | date }} - {{ trip.endDate | date }}</p>
    </div>
  </div>

  <div class="members-section">
    <div class="members-list">
      
      <div *ngFor="let m of trip.members" class="member-chip" [class.pending]="m.status === 'pending'">
        <img [src]="m.avatarUrl" [title]="m.name" class="member-avatar">
        
        <span *ngIf="trip.creatorId === m.id" class="crown-icon" title="LÃ­der del viaje">ğŸ‘‘</span>
        
        <span *ngIf="m.status === 'pending'" class="status-badge">â³</span>

        <button *ngIf="isLeader && trip.creatorId !== m.id" 
                class="btn-kick" (click)="removeMember(m)" title="Expulsar">
          âŒ
        </button>
      </div>

      <button *ngIf="isLeader" class="btn-add-member" (click)="openInviteModal()">+</button>
    </div>

    <div class="trip-meta">
      <h2>{{ trip.name }}</h2>
      <span class="badge" *ngIf="isLeader">Eres el LÃ­der ğŸ˜</span>
    </div>
  </div>

  <div class="tabs-container">
    <button class="tab-btn" [class.active]="activeTab === 'itinerary'" (click)="switchTab('itinerary')">
      ğŸ—ºï¸ Itinerario
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'expenses'" (click)="switchTab('expenses')">
      ğŸ’¸ Gastos
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'map'" (click)="switchTab('map')">
      ğŸ“ Mapa
    </button>
  </div>

  <div class="itinerary" *ngIf="activeTab === 'itinerary'">
    <div class="days-container">
        <div class="day-card" *ngFor="let day of daysArray">
          <div class="day-header">
            <h4>DÃ­a {{ day }}</h4>
            <button class="btn-mini" (click)="openAddActivity(day)">+ Actividad</button>
          </div>
          <div class="activities-list">
            <div *ngFor="let act of getActivitiesForDay(day)" class="activity-item" [ngClass]="act.type">
              <span class="time">{{ act.time }}</span>
              <div class="act-info"><strong>{{ act.title }}</strong><p>{{ act.description }}</p></div>
              <button class="btn-icon-del" (click)="deleteActivity(act.id)">Ã—</button>
            </div>
          </div>
        </div>
      </div>
  </div>

  <div class="expenses-section" *ngIf="activeTab === 'expenses'">
    <div class="expenses-header">
        <div class="total-box"><span>Total</span><strong>{{ getTotalExpenses() | currency:'EUR' }}</strong></div>
        <button class="btn-primary" (click)="openAddExpense()">+ Gasto</button>
    </div>
    <div class="expenses-list">
        <div class="expense-card" *ngFor="let expense of expenses">
          <div class="expense-icon">ğŸ’°</div>
          <div class="expense-info"><strong>{{ expense.title }}</strong><small>{{ getPayerName(expense.payerId) }}</small></div>
          <div class="expense-amount">{{ expense.amount | currency:'EUR' }}</div>
          <button class="btn-icon-del" (click)="deleteExpense(expense.id)">Ã—</button>
        </div>
    </div>
  </div>

  <div class="map-section" *ngIf="activeTab === 'map'">
    <div class="map-card">
      <google-map height="500px" width="100%" [center]="mapCenter" [zoom]="mapZoom" [options]="mapOptions">
        <map-marker *ngFor="let marker of markers" [position]="marker.position"></map-marker>
      </google-map>
    </div>
  </div>

</div>

<div class="custom-overlay" *ngIf="showInviteModal" (click)="showInviteModal = false">
  <div class="custom-modal" (click)="$event.stopPropagation()">
    <h3>Invitar (Solo LÃ­der)</h3>
    <div class="friends-list-modal">
        <div *ngFor="let f of myFriends" class="friend-row">
            <div class="f-info"><img [src]="f.avatar" class="mini-avatar">{{ f.name }}</div>
            <button class="btn-invite" (click)="inviteFriend(f)">Invitar</button>
        </div>
    </div>
  </div>
</div>
<div class="custom-overlay" *ngIf="showActivityModal" (click)="showActivityModal = false">
    <div class="custom-modal" (click)="$event.stopPropagation()">
      <form [formGroup]="activityForm" (ngSubmit)="saveActivity()">
        <h3>Nueva Actividad</h3>
        <div class="form-group"><input type="time" formControlName="time"></div>
        <div class="form-group"><input type="text" formControlName="title" placeholder="TÃ­tulo"></div>
        <button class="btn-save">Guardar</button>
      </form>
    </div>
</div>
<div class="custom-overlay" *ngIf="showExpenseModal" (click)="showExpenseModal = false">
    <div class="custom-modal" (click)="$event.stopPropagation()">
      <form [formGroup]="expenseForm" (ngSubmit)="saveExpense()">
        <h3>Nuevo Gasto</h3>
        <div class="form-group"><input type="text" formControlName="title" placeholder="Concepto"></div>
        <div class="form-group"><input type="number" formControlName="amount" placeholder="â‚¬"></div>
        <div class="form-group"><select formControlName="payerId"><option *ngFor="let m of trip.members" [value]="m.id">{{ m.name }}</option></select></div>
        <button class="btn-save">Guardar</button>
      </form>
    </div>
</div>